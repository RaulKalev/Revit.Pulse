<Window
    x:Class="Pulse.UI.SymbolDesignerWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="clr-namespace:Pulse.UI"
    xmlns:vm="clr-namespace:Pulse.UI.ViewModels"
    xmlns:conv="clr-namespace:Pulse.UI.Converters"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    Title="Pulse — Symbol Designer"
    Width="860"
    Height="620"
    MinWidth="640"
    MinHeight="480"
    AllowsTransparency="True"
    Background="Transparent"
    WindowStyle="None"
    WindowStartupLocation="CenterOwner"
    mc:Ignorable="d">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Pulse;component/UI/Themes/DarkTheme.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.Dark.xaml" />
                <ResourceDictionary Source="pack://application:,,,/Pulse;component/UI/Themes/ElementStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <BooleanToVisibilityConverter x:Key="BoolToVis" />
            <conv:ColorHexToBrushConverter   x:Key="HexToBrush" />
            <conv:EnumEqualsConverter        x:Key="EnumEquals" />

            <!-- ── Tool button style ───────────────────────────────────────── -->
            <Style x:Key="ToolButtonStyle" TargetType="{x:Type Button}">
                <Setter Property="OverridesDefaultStyle"  Value="True" />
                <Setter Property="Background"             Value="Transparent" />
                <Setter Property="Foreground"             Value="{DynamicResource IconForegroundBrush}" />
                <Setter Property="BorderBrush"            Value="Transparent" />
                <Setter Property="BorderThickness"        Value="1" />
                <Setter Property="Width"                  Value="40" />
                <Setter Property="Height"                 Value="40" />
                <Setter Property="Cursor"                 Value="Hand" />
                <Setter Property="ToolTipService.ShowOnDisabled" Value="True" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type Button}">
                            <Border x:Name="Bd"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="6"
                                    Margin="2">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="Bd" Property="Background" Value="{DynamicResource HighlightBrush}" />
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="Bd" Property="Background" Value="{DynamicResource SelectionHoverBrush}" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- Active tool button: blue tinted background -->
            <Style x:Key="ToolButtonActiveStyle" TargetType="{x:Type Button}"
                   BasedOn="{StaticResource ToolButtonStyle}">
                <Setter Property="Background"   Value="#220078D7" />
                <Setter Property="BorderBrush"  Value="#880078D7" />
                <Setter Property="Foreground"   Value="#FF0078D7" />
            </Style>

            <!-- ── Properties TextBox ─────────────────────────────────────── -->
            <Style x:Key="PropTextBoxStyle" TargetType="{x:Type TextBox}">
                <Setter Property="Background"      Value="{DynamicResource PrimaryBackgroundBrush}" />
                <Setter Property="Foreground"      Value="{DynamicResource ForegroundBrush}" />
                <Setter Property="BorderBrush"     Value="{DynamicResource BorderBrush}" />
                <Setter Property="BorderThickness" Value="1" />
                <Setter Property="Height"          Value="24" />
                <Setter Property="Padding"         Value="5,2" />
                <Setter Property="FontSize"        Value="11" />
                <Setter Property="CaretBrush"      Value="{DynamicResource ForegroundBrush}" />
                <Setter Property="VerticalContentAlignment" Value="Center" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type TextBox}">
                            <Border x:Name="Bd"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="4"
                                    Padding="{TemplateBinding Padding}">
                                <ScrollViewer x:Name="PART_ContentHost"
                                              HorizontalScrollBarVisibility="Hidden"
                                              VerticalScrollBarVisibility="Hidden"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsFocused" Value="True">
                                    <Setter TargetName="Bd" Property="BorderBrush" Value="#FF0078D7" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- ── Color swatch button ─────────────────────────────────────── -->
            <Style x:Key="SwatchButtonStyle" TargetType="{x:Type Button}">
                <Setter Property="OverridesDefaultStyle"  Value="True" />
                <Setter Property="Width"                  Value="20" />
                <Setter Property="Height"                 Value="20" />
                <Setter Property="Padding"                Value="0" />
                <Setter Property="Cursor"                 Value="Hand" />
                <Setter Property="BorderThickness"        Value="1" />
                <Setter Property="BorderBrush"            Value="#44FFFFFF" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type Button}">
                            <Border x:Name="Bd"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="3"
                                    Margin="1" />
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="Bd" Property="BorderBrush" Value="White" />
                                    <Setter TargetName="Bd" Property="BorderThickness" Value="2" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- ── Toolbar small TextBox ──────────────────────────────────── -->
            <Style x:Key="ToolbarTextBoxStyle" TargetType="{x:Type TextBox}"
                   BasedOn="{StaticResource PropTextBoxStyle}">
                <Setter Property="Height"  Value="22" />
                <Setter Property="FontSize" Value="11" />
            </Style>

            <!-- ── Section header label ───────────────────────────────────── -->
            <Style x:Key="SectionLabelStyle" TargetType="{x:Type TextBlock}">
                <Setter Property="FontSize"   Value="9" />
                <Setter Property="FontWeight" Value="SemiBold" />
                <Setter Property="Foreground" Value="{DynamicResource IconForegroundBrush}" />
                <Setter Property="Margin"     Value="0,8,0,3" />
            </Style>

            <!-- ── Color picker trigger button (looks like a swatch, opens popup) -->
            <Style x:Key="ColorPickerTriggerStyle" TargetType="{x:Type Button}">
                <Setter Property="OverridesDefaultStyle" Value="True" />
                <Setter Property="Cursor"                Value="Hand" />
                <Setter Property="Padding"               Value="0" />
                <Setter Property="ToolTip"               Value="Open color picker" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type Button}">
                            <Border x:Name="Bd"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="3">
                                <materialDesign:PackIcon x:Name="Ico"
                                                         Kind="Eyedropper"
                                                         Width="12" Height="12"
                                                         HorizontalAlignment="Center"
                                                         VerticalAlignment="Center"
                                                         Foreground="White"
                                                         Opacity="0" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="Bd" Property="BorderBrush" Value="White" />
                                    <Setter TargetName="Bd" Property="BorderThickness" Value="2" />
                                    <Setter TargetName="Ico" Property="Opacity" Value="0.8" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- ── Save-swatch button (used at bottom of each color popup) ──── -->
            <Style x:Key="SaveSwatchButtonStyle" TargetType="{x:Type Button}">
                <Setter Property="OverridesDefaultStyle" Value="True" />
                <Setter Property="Height"               Value="22" />
                <Setter Property="Cursor"               Value="Hand" />
                <Setter Property="HorizontalAlignment" Value="Stretch" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type Button}">
                            <Border x:Name="Bd"
                                    Background="Transparent"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4">
                                <TextBlock Text="＋ Save swatch"
                                           FontSize="10"
                                           Foreground="{DynamicResource IconForegroundBrush}"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="Bd" Property="Background" Value="{DynamicResource HighlightBrush}" />
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="Bd" Property="Background" Value="{DynamicResource SelectionHoverBrush}" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- ── Slider for color picker RGB channels ───────────────────── -->
            <Style x:Key="RgbSliderStyle" TargetType="{x:Type Slider}">
                <Setter Property="OverridesDefaultStyle" Value="True" />
                <Setter Property="Minimum"               Value="0" />
                <Setter Property="Maximum"               Value="255" />
                <Setter Property="SmallChange"           Value="1" />
                <Setter Property="LargeChange"           Value="16" />
                <Setter Property="Height"                Value="16" />
                <!-- Focusable=False prevents the Popup's HwndSource from consuming
                     the first mouse-down for focus, which caused double-click-to-drag -->
                <Setter Property="Focusable"             Value="False" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type Slider}">
                            <Grid VerticalAlignment="Center">
                                <Track x:Name="PART_Track">
                                    <Track.DecreaseRepeatButton>
                                        <RepeatButton Command="{x:Static Slider.DecreaseLarge}" Focusable="False">
                                            <RepeatButton.Template>
                                                <ControlTemplate TargetType="RepeatButton">
                                                    <Border Height="4" Background="{DynamicResource AccentBrush}" CornerRadius="2,0,0,2" />
                                                </ControlTemplate>
                                            </RepeatButton.Template>
                                        </RepeatButton>
                                    </Track.DecreaseRepeatButton>
                                    <Track.IncreaseRepeatButton>
                                        <RepeatButton Command="{x:Static Slider.IncreaseLarge}" Focusable="False">
                                            <RepeatButton.Template>
                                                <ControlTemplate TargetType="RepeatButton">
                                                    <Border Height="4" Background="{DynamicResource BorderBrush}" CornerRadius="0,2,2,0" />
                                                </ControlTemplate>
                                            </RepeatButton.Template>
                                        </RepeatButton>
                                    </Track.IncreaseRepeatButton>
                                    <Track.Thumb>
                                        <Thumb Focusable="False">
                                            <Thumb.Template>
                                                <ControlTemplate TargetType="Thumb">
                                                    <Ellipse Width="12" Height="12"
                                                             Fill="{DynamicResource AccentBrush}"
                                                             Stroke="{DynamicResource ForegroundBrush}"
                                                             StrokeThickness="1" />
                                                </ControlTemplate>
                                            </Thumb.Template>
                                        </Thumb>
                                    </Track.Thumb>
                                </Track>
                            </Grid>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
        </ResourceDictionary>
    </Window.Resources>

    <Grid Background="Transparent">
        <!-- Frosted edge glow -->
        <Border BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="2" CornerRadius="10" Opacity="0.7" SnapsToDevicePixels="True">
            <Border.Effect><BlurEffect KernelType="Gaussian" Radius="2" /></Border.Effect>
        </Border>

        <!-- Main surface -->
        <Border Margin="2"
                Background="{DynamicResource PrimaryBackgroundBrush}"
                CornerRadius="10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="30" />   <!-- Title bar -->
                    <RowDefinition Height="Auto" /> <!-- Top toolbar -->
                    <RowDefinition Height="*" />    <!-- Content -->
                    <RowDefinition Height="Auto" /> <!-- Footer -->
                </Grid.RowDefinitions>

                <!-- ── Title bar ──────────────────────────────────────────── -->
                <ui:TitleBar Grid.Row="0" IsMinimizeVisible="False" />

                <!-- ── Top toolbar ────────────────────────────────────────── -->
                <Border Grid.Row="1"
                        Background="{DynamicResource SecondaryBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,0,0,1"
                        Padding="12,7">
                    <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">

                        <!-- Symbol name -->
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,16,0">
                            <TextBlock Text="Name:" FontSize="11"
                                       Foreground="{DynamicResource IconForegroundBrush}"
                                       VerticalAlignment="Center" Margin="0,0,6,0" />
                            <TextBox Style="{StaticResource ToolbarTextBoxStyle}"
                                     Width="160"
                                     Text="{Binding SymbolName, UpdateSourceTrigger=PropertyChanged}" />
                        </StackPanel>

                        <!-- Separator -->
                        <Border Width="1" Height="18" Background="{DynamicResource BorderBrush}"
                                VerticalAlignment="Center" Margin="0,0,16,0" />

                        <!-- Viewbox size -->
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,16,0">
                            <TextBlock Text="Size:" FontSize="11"
                                       Foreground="{DynamicResource IconForegroundBrush}"
                                       VerticalAlignment="Center" Margin="0,0,6,0" />
                            <TextBox x:Name="TbWidth"
                                     Style="{StaticResource ToolbarTextBoxStyle}" Width="42"
                                     Text="{Binding ViewboxWidthMm, UpdateSourceTrigger=LostFocus, StringFormat={}{0:F0}}" />
                            <TextBlock Text="×" FontSize="11"
                                       Foreground="{DynamicResource IconForegroundBrush}"
                                       VerticalAlignment="Center" Margin="4,0" />
                            <TextBox x:Name="TbHeight"
                                     Style="{StaticResource ToolbarTextBoxStyle}" Width="42"
                                     Text="{Binding ViewboxHeightMm, UpdateSourceTrigger=LostFocus, StringFormat={}{0:F0}}" />
                            <TextBlock Text="mm" FontSize="11"
                                       Foreground="{DynamicResource IconForegroundBrush}"
                                       VerticalAlignment="Center" Margin="4,0,0,0" />
                        </StackPanel>

                        <!-- Separator -->
                        <Border Width="1" Height="18" Background="{DynamicResource BorderBrush}"
                                VerticalAlignment="Center" Margin="0,0,16,0" />

                        <!-- Grid size -->
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,16,0">
                            <TextBlock Text="Grid:" FontSize="11"
                                       Foreground="{DynamicResource IconForegroundBrush}"
                                       VerticalAlignment="Center" Margin="0,0,6,0" />
                            <TextBox Style="{StaticResource ToolbarTextBoxStyle}" Width="36"
                                     Text="{Binding GridSizeMm, UpdateSourceTrigger=LostFocus, StringFormat={}{0:F1}}" />
                            <TextBlock Text="mm" FontSize="11"
                                       Foreground="{DynamicResource IconForegroundBrush}"
                                       VerticalAlignment="Center" Margin="4,0,0,0" />
                        </StackPanel>

                        <!-- Snap toggle -->
                        <CheckBox IsChecked="{Binding SnapToGrid}"
                                  VerticalAlignment="Center"
                                  Margin="0,0,16,0"
                                  Foreground="{DynamicResource ForegroundBrush}"
                                  FontSize="11">
                            <TextBlock Text="Snap" FontSize="11" />
                        </CheckBox>

                        <!-- Separator -->
                        <Border Width="1" Height="18" Background="{DynamicResource BorderBrush}"
                                VerticalAlignment="Center" Margin="0,0,12,0" />

                        <!-- Import DXF / SVG -->
                        <Button x:Name="BtnImport"
                                VerticalAlignment="Center"
                                Margin="0,0,0,0"
                                Click="BtnImport_Click"
                                Style="{StaticResource ToolButtonStyle}"
                                Width="Auto" Height="26"
                                Padding="8,0"
                                ToolTip="Import DXF or SVG file — entities are added to the canvas">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="FolderOpen" Width="14" Height="14"
                                                         VerticalAlignment="Center" Margin="0,0,5,0" />
                                <TextBlock Text="Import DXF / SVG" FontSize="11" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>

                        <!-- Separator -->
                        <Border Width="1" Height="18" Background="{DynamicResource BorderBrush}"
                                VerticalAlignment="Center" Margin="12,0,12,0" />

                        <!-- Select All -->
                        <Button Command="{Binding SelectAllCommand}"
                                Style="{StaticResource ToolButtonStyle}"
                                Width="Auto" Height="26" Padding="8,0"
                                VerticalAlignment="Center" Margin="0,0,8,0"
                                ToolTip="Select all elements (Ctrl+A)">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="SelectAll" Width="14" Height="14"
                                                         VerticalAlignment="Center" Margin="0,0,5,0" />
                                <TextBlock Text="Select All" FontSize="11" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>

                        <!-- Scale All -->
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="Scale:" FontSize="11"
                                       Foreground="{DynamicResource IconForegroundBrush}"
                                       VerticalAlignment="Center" Margin="0,0,6,0" />
                            <TextBox x:Name="TbScaleFactor"
                                     Style="{StaticResource ToolbarTextBoxStyle}" Width="42"
                                     Text="1.0"
                                     KeyDown="TbScaleFactor_KeyDown" />
                            <TextBlock Text="×" FontSize="11"
                                       Foreground="{DynamicResource IconForegroundBrush}"
                                       VerticalAlignment="Center" Margin="4,0,6,0" />
                            <Button x:Name="BtnScaleApply"
                                    Click="BtnScaleApply_Click"
                                    Style="{StaticResource ToolButtonStyle}"
                                    Width="Auto" Height="26" Padding="8,0"
                                    VerticalAlignment="Center"
                                    ToolTip="Scale selected elements (or all, if none selected) relative to the snap origin. Press Enter in the textbox or click here.">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="ArrowExpandAll" Width="14" Height="14"
                                                             VerticalAlignment="Center" Margin="0,0,5,0" />
                                    <TextBlock Text="Scale" FontSize="11" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </WrapPanel>
                </Border>

                <!-- ── Content: [Tools | Canvas | Properties] ─────────────── -->
                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="52" />   <!-- Tool palette -->
                        <ColumnDefinition Width="*" />    <!-- Canvas -->
                        <ColumnDefinition Width="192" />  <!-- Properties -->
                    </Grid.ColumnDefinitions>

                    <!-- ── Tool palette ─────────────────────────────────── -->
                    <Border Grid.Column="0"
                            Background="{DynamicResource SecondaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,0,1,0">
                        <StackPanel Margin="4,8,4,0" VerticalAlignment="Top">

                            <!-- SELECT -->
                            <Button x:Name="BtnSelect"
                                    Command="{Binding SelectToolCommand}"
                                    ToolTip="Select (V)"
                                    VerticalAlignment="Center">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource ToolButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <Binding Path="ActiveTool" Converter="{StaticResource EnumEquals}"
                                                             ConverterParameter="{x:Static vm:DesignerTool.Select}" />
                                                </DataTrigger.Binding>
                                                <Setter Property="Background"  Value="#220078D7" />
                                                <Setter Property="BorderBrush" Value="#880078D7" />
                                                <Setter Property="Foreground"  Value="#FF0078D7" />
                                                <Setter Property="BorderThickness" Value="1" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <materialDesign:PackIcon Kind="CursorDefaultOutline" Width="18" Height="18" />
                            </Button>

                            <!-- LINE -->
                            <Button x:Name="BtnLine"
                                    Command="{Binding LineToolCommand}"
                                    ToolTip="Line (L) — click to start, click to end">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource ToolButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <Binding Path="ActiveTool" Converter="{StaticResource EnumEquals}"
                                                             ConverterParameter="{x:Static vm:DesignerTool.Line}" />
                                                </DataTrigger.Binding>
                                                <Setter Property="Background"  Value="#220078D7" />
                                                <Setter Property="BorderBrush" Value="#880078D7" />
                                                <Setter Property="Foreground"  Value="#FF0078D7" />
                                                <Setter Property="BorderThickness" Value="1" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <materialDesign:PackIcon Kind="VectorLine" Width="18" Height="18" />
                            </Button>

                            <!-- POLYLINE -->
                            <Button x:Name="BtnPolyline"
                                    Command="{Binding PolylineToolCommand}"
                                    ToolTip="Polyline / Polygon (P) — click to add points, double-click to finish">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource ToolButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <Binding Path="ActiveTool" Converter="{StaticResource EnumEquals}"
                                                             ConverterParameter="{x:Static vm:DesignerTool.Polyline}" />
                                                </DataTrigger.Binding>
                                                <Setter Property="Background"  Value="#220078D7" />
                                                <Setter Property="BorderBrush" Value="#880078D7" />
                                                <Setter Property="Foreground"  Value="#FF0078D7" />
                                                <Setter Property="BorderThickness" Value="1" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <materialDesign:PackIcon Kind="VectorPolyline" Width="18" Height="18" />
                            </Button>

                            <!-- CIRCLE -->
                            <Button x:Name="BtnCircle"
                                    Command="{Binding CircleToolCommand}"
                                    ToolTip="Circle (C) — click centre, drag to set radius">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource ToolButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <Binding Path="ActiveTool" Converter="{StaticResource EnumEquals}"
                                                             ConverterParameter="{x:Static vm:DesignerTool.Circle}" />
                                                </DataTrigger.Binding>
                                                <Setter Property="Background"  Value="#220078D7" />
                                                <Setter Property="BorderBrush" Value="#880078D7" />
                                                <Setter Property="Foreground"  Value="#FF0078D7" />
                                                <Setter Property="BorderThickness" Value="1" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <materialDesign:PackIcon Kind="CircleOutline" Width="18" Height="18" />
                            </Button>

                            <!-- RECTANGLE -->
                            <Button x:Name="BtnRectangle"
                                    Command="{Binding RectangleToolCommand}"
                                    ToolTip="Rectangle (R) — click to set first corner, drag to second">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource ToolButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <Binding Path="ActiveTool" Converter="{StaticResource EnumEquals}"
                                                             ConverterParameter="{x:Static vm:DesignerTool.Rectangle}" />
                                                </DataTrigger.Binding>
                                                <Setter Property="Background"  Value="#220078D7" />
                                                <Setter Property="BorderBrush" Value="#880078D7" />
                                                <Setter Property="Foreground"  Value="#FF0078D7" />
                                                <Setter Property="BorderThickness" Value="1" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <materialDesign:PackIcon Kind="SquareOutline" Width="18" Height="18" />
                            </Button>

                            <!-- PAINT BUCKET -->
                            <Button x:Name="BtnPaintBucket"
                                    Command="{Binding PaintBucketToolCommand}"
                                    ToolTip="Fill (B) — click a shape to flood-fill it with the current fill colour">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource ToolButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <Binding Path="ActiveTool" Converter="{StaticResource EnumEquals}"
                                                             ConverterParameter="{x:Static vm:DesignerTool.PaintBucket}" />
                                                </DataTrigger.Binding>
                                                <Setter Property="Background"  Value="#220078D7" />
                                                <Setter Property="BorderBrush" Value="#880078D7" />
                                                <Setter Property="Foreground"  Value="#FF0078D7" />
                                                <Setter Property="BorderThickness" Value="1" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <materialDesign:PackIcon Kind="FormatColorFill" Width="18" Height="18" />
                            </Button>

                            <!-- SCALE TOOL -->
                            <Button x:Name="BtnScaleTool"
                                    Command="{Binding ScaleToolCommand}"
                                    ToolTip="Scale Tool (S) — click base point, reference point, then target point to scale">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource ToolButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <Binding Path="ActiveTool" Converter="{StaticResource EnumEquals}"
                                                             ConverterParameter="{x:Static vm:DesignerTool.ScaleTool}" />
                                                </DataTrigger.Binding>
                                                <Setter Property="Background"  Value="#220078D7" />
                                                <Setter Property="BorderBrush" Value="#880078D7" />
                                                <Setter Property="Foreground"  Value="#FF0078D7" />
                                                <Setter Property="BorderThickness" Value="1" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <materialDesign:PackIcon Kind="ArrowExpand" Width="18" Height="18" />
                            </Button>

                        </StackPanel>
                    </Border>

                    <!-- ── Drawing canvas ───────────────────────────────── -->
                    <ScrollViewer Grid.Column="1"
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto"
                                  Background="#FF0E0E16"
                                  Padding="20">
                        <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="18" />   <!-- Horizontal ruler -->
                                <RowDefinition Height="Auto" /> <!-- Canvas row -->
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="18" />   <!-- Vertical ruler -->
                                <ColumnDefinition Width="Auto" /> <!-- Canvas column -->
                            </Grid.ColumnDefinitions>

                            <!-- Corner square (top-left junction) -->
                            <Border Grid.Row="0" Grid.Column="0" Background="#1A1A2E" />

                            <!-- Horizontal ruler -->
                            <Canvas x:Name="RulerH"
                                    Grid.Row="0" Grid.Column="1"
                                    Width="{Binding CanvasWidthPx}" Height="18"
                                    Background="#1A1A2E" />

                            <!-- Vertical ruler -->
                            <Canvas x:Name="RulerV"
                                    Grid.Row="1" Grid.Column="0"
                                    Width="18" Height="{Binding CanvasHeightPx}"
                                    Background="#1A1A2E" />

                            <!-- Canvas area -->
                            <Grid Grid.Row="1" Grid.Column="1"
                                  HorizontalAlignment="Center" VerticalAlignment="Center">
                                <!-- Drop shadow behind canvas -->
                                <Border>
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="16" ShadowDepth="4"
                                                          Color="Black" Opacity="0.6" />
                                    </Border.Effect>
                                    <Border Width="{Binding CanvasWidthPx}"
                                            Height="{Binding CanvasHeightPx}"
                                            Background="#FF1A1A2E"
                                            CornerRadius="2" />
                                </Border>

                                <!-- The actual drawing canvas -->
                                <Canvas x:Name="DrawingCanvas"
                                        Width="{Binding CanvasWidthPx}"
                                        Height="{Binding CanvasHeightPx}"
                                        ClipToBounds="True"
                                        Background="Transparent"
                                        Cursor="Cross"
                                        MouseMove="DrawingCanvas_MouseMove"
                                        MouseDown="DrawingCanvas_MouseDown"
                                        MouseUp="DrawingCanvas_MouseUp"
                                        MouseLeave="DrawingCanvas_MouseLeave" />
                            </Grid>
                        </Grid>
                    </ScrollViewer>

                    <!-- ── Properties panel ──────────────────────────────── -->
                    <Border Grid.Column="2"
                            Background="{DynamicResource SecondaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1,0,0,0">
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                                      HorizontalScrollBarVisibility="Disabled">
                            <StackPanel Margin="12,10,12,10">

                                <!-- ── Multi-selection banner ──────────── -->
                                <Border CornerRadius="4" Padding="8,5" Margin="0,0,0,8"
                                        Background="#2200D4FF" BorderBrush="#5500D4FF"
                                        BorderThickness="1">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Visibility" Value="Visible" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectionInfo}" Value="">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock Text="{Binding SelectionInfo}"
                                               Foreground="#FF00D4FF"
                                               FontSize="11" FontWeight="SemiBold"
                                               TextWrapping="Wrap" />
                                </Border>

                                <!-- ── Stroke ──────────────────────────── -->
                                <TextBlock Text="STROKE" Style="{StaticResource SectionLabelStyle}"
                                           Margin="0,0,0,4" />

                                <!-- Stroke color swatches -->
                                <WrapPanel x:Name="StrokeSwatches" Margin="0,0,0,5">
                                    <Button Tag="#FF0000" ToolTip="#FF0000"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#FF0000" Click="StrokeSwatch_Click" />
                                    <Button Tag="#CC0000" ToolTip="#CC0000"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#CC0000" Click="StrokeSwatch_Click" />
                                    <Button Tag="#1A1A1A" ToolTip="#1A1A1A"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#1A1A1A" Click="StrokeSwatch_Click" />
                                    <Button Tag="#808080" ToolTip="#808080"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#808080" Click="StrokeSwatch_Click" />
                                    <Button Tag="#E0E0E0" ToolTip="#E0E0E0"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#E0E0E0" Click="StrokeSwatch_Click" />
                                    <Button Tag="#0078D7" ToolTip="#0078D7"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#0078D7" Click="StrokeSwatch_Click" />
                                    <Button Tag="#28A745" ToolTip="#28A745"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#28A745" Click="StrokeSwatch_Click" />
                                    <Button Tag="#FFA500" ToolTip="#FFA500"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#FFA500" Click="StrokeSwatch_Click" />
                                    <Button Tag="#FFD700" ToolTip="#FFD700"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#FFD700" Click="StrokeSwatch_Click" />
                                    <Button Tag="#9B59B6" ToolTip="#9B59B6"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#9B59B6" Click="StrokeSwatch_Click" />
                                </WrapPanel>

                                <!-- Custom stroke color swatches (saved by user) -->
                                <WrapPanel x:Name="StrokeCustomSwatchesPanel" Margin="0,0,0,5" />

                                <!-- Stroke hex + preview -->
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="26" />
                                    </Grid.ColumnDefinitions>
                                    <TextBox Grid.Column="0"
                                             Style="{StaticResource PropTextBoxStyle}"
                                             Text="{Binding StrokeColor, UpdateSourceTrigger=PropertyChanged}"
                                             FontFamily="Consolas"
                                             Margin="0,0,4,0" />
                                    <Button x:Name="StrokeColorButton"
                                            Grid.Column="1"
                                            Width="22" Height="22"
                                            VerticalAlignment="Center"
                                            Style="{StaticResource ColorPickerTriggerStyle}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            Background="{Binding StrokeColor, Converter={StaticResource HexToBrush}}"
                                            Click="StrokeColorButton_Click" />
                                </Grid>

                                <!-- Stroke color picker popup -->
                                <Popup x:Name="StrokePickerPopup"
                                       PlacementTarget="{Binding ElementName=StrokeColorButton}"
                                       Placement="Left"
                                       HorizontalOffset="-4"
                                       StaysOpen="False"
                                       AllowsTransparency="True"
                                       PopupAnimation="Fade">
                                    <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="6"
                                            Padding="10"
                                            Width="170">
                                        <StackPanel>
                                            <!-- Large live color preview -->
                                            <Border Height="28" CornerRadius="4" Margin="0,0,0,8"
                                                    BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1"
                                                    Background="{Binding StrokeColor, Converter={StaticResource HexToBrush}}" />
                                            <!-- R row -->
                                            <Grid Margin="0,0,0,4">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="14" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="28" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="R" Foreground="#FFCC4444" FontSize="10" FontWeight="Bold"
                                                           VerticalAlignment="Center" />
                                                <Slider Grid.Column="1" Style="{StaticResource RgbSliderStyle}"
                                                        Value="{Binding StrokeR}" Margin="3,0" />
                                                <TextBlock Grid.Column="2" Text="{Binding StrokeR}" FontSize="10"
                                                           Foreground="{DynamicResource ForegroundBrush}"
                                                           VerticalAlignment="Center" HorizontalAlignment="Right" />
                                            </Grid>
                                            <!-- G row -->
                                            <Grid Margin="0,0,0,4">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="14" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="28" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="G" Foreground="#FF44CC44" FontSize="10" FontWeight="Bold"
                                                           VerticalAlignment="Center" />
                                                <Slider Grid.Column="1" Style="{StaticResource RgbSliderStyle}"
                                                        Value="{Binding StrokeG}" Margin="3,0" />
                                                <TextBlock Grid.Column="2" Text="{Binding StrokeG}" FontSize="10"
                                                           Foreground="{DynamicResource ForegroundBrush}"
                                                           VerticalAlignment="Center" HorizontalAlignment="Right" />
                                            </Grid>
                                            <!-- B row -->
                                            <Grid Margin="0,0,0,6">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="14" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="28" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="B" Foreground="#FF4488FF" FontSize="10" FontWeight="Bold"
                                                           VerticalAlignment="Center" />
                                                <Slider Grid.Column="1" Style="{StaticResource RgbSliderStyle}"
                                                        Value="{Binding StrokeB}" Margin="3,0" />
                                                <TextBlock Grid.Column="2" Text="{Binding StrokeB}" FontSize="10"
                                                           Foreground="{DynamicResource ForegroundBrush}"
                                                           VerticalAlignment="Center" HorizontalAlignment="Right" />
                                            </Grid>
                                            <!-- Hex entry -->
                                            <TextBox Text="{Binding StrokeColor, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{StaticResource PropTextBoxStyle}"
                                                     FontFamily="Consolas" />
                                            <!-- Save custom swatch -->
                                            <Button Margin="0,6,0,0"
                                                    Style="{StaticResource SaveSwatchButtonStyle}"
                                                    ToolTip="Save current color as a custom swatch&#x0a;Right-click any custom swatch to remove it"
                                                    Click="SaveStrokeSwatch_Click" />
                                        </StackPanel>
                                    </Border>
                                </Popup>

                                <!-- Stroke thickness -->
                                <TextBlock Text="THICKNESS (mm)" Style="{StaticResource SectionLabelStyle}" />
                                <TextBox Style="{StaticResource PropTextBoxStyle}"
                                         Text="{Binding StrokeThicknessMm, UpdateSourceTrigger=LostFocus, StringFormat={}{0:F2}}" />

                                <!-- ── Fill ────────────────────────────── -->
                                <TextBlock Text="FILL" Style="{StaticResource SectionLabelStyle}" />

                                <CheckBox IsChecked="{Binding IsFilled}"
                                          Foreground="{DynamicResource ForegroundBrush}"
                                          FontSize="11" Margin="0,0,0,6">
                                    <TextBlock Text="Enable fill" FontSize="11" />
                                </CheckBox>

                                <!-- Fill swatches -->
                                <WrapPanel x:Name="FillSwatches"
                                           Margin="0,0,0,5"
                                           Visibility="{Binding IsFilled, Converter={StaticResource BoolToVis}}">
                                    <Button Tag="#FF0000" ToolTip="#FF0000"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#FF0000" Click="FillSwatch_Click" />
                                    <Button Tag="#CC0000" ToolTip="#CC0000"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#CC0000" Click="FillSwatch_Click" />
                                    <Button Tag="#1A1A1A" ToolTip="#1A1A1A"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#1A1A1A" Click="FillSwatch_Click" />
                                    <Button Tag="#808080" ToolTip="#808080"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#808080" Click="FillSwatch_Click" />
                                    <Button Tag="#E0E0E0" ToolTip="#E0E0E0"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#E0E0E0" Click="FillSwatch_Click" />
                                    <Button Tag="#0078D7" ToolTip="#0078D7"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#0078D7" Click="FillSwatch_Click" />
                                    <Button Tag="#28A745" ToolTip="#28A745"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#28A745" Click="FillSwatch_Click" />
                                    <Button Tag="#FFA500" ToolTip="#FFA500"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#FFA500" Click="FillSwatch_Click" />
                                    <Button Tag="#FFD700" ToolTip="#FFD700"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#FFD700" Click="FillSwatch_Click" />
                                    <Button Tag="#9B59B6" ToolTip="#9B59B6"
                                            Style="{StaticResource SwatchButtonStyle}"
                                            Background="#9B59B6" Click="FillSwatch_Click" />
                                </WrapPanel>

                                <!-- Custom fill color swatches (saved by user) -->
                                <WrapPanel x:Name="FillCustomSwatchesPanel" Margin="0,0,0,5"
                                           Visibility="{Binding IsFilled, Converter={StaticResource BoolToVis}}" />

                                <!-- Fill hex + preview -->
                                <Grid Margin="0,0,0,2"
                                      Visibility="{Binding IsFilled, Converter={StaticResource BoolToVis}}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="26" />
                                    </Grid.ColumnDefinitions>
                                    <TextBox Grid.Column="0"
                                             Style="{StaticResource PropTextBoxStyle}"
                                             Text="{Binding FillColor, UpdateSourceTrigger=PropertyChanged}"
                                             FontFamily="Consolas"
                                             Margin="0,0,4,0" />
                                    <Button x:Name="FillColorButton"
                                            Grid.Column="1"
                                            Width="22" Height="22"
                                            VerticalAlignment="Center"
                                            Style="{StaticResource ColorPickerTriggerStyle}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            Background="{Binding FillColor, Converter={StaticResource HexToBrush}}"
                                            Click="FillColorButton_Click" />
                                </Grid>

                                <!-- Fill color picker popup -->
                                <Popup x:Name="FillPickerPopup"
                                       PlacementTarget="{Binding ElementName=FillColorButton}"
                                       Placement="Left"
                                       HorizontalOffset="-4"
                                       StaysOpen="False"
                                       AllowsTransparency="True"
                                       PopupAnimation="Fade"
                                       Visibility="{Binding IsFilled, Converter={StaticResource BoolToVis}}">
                                    <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="6"
                                            Padding="10"
                                            Width="170">
                                        <StackPanel>
                                            <!-- Large live color preview -->
                                            <Border Height="28" CornerRadius="4" Margin="0,0,0,8"
                                                    BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1"
                                                    Background="{Binding FillColor, Converter={StaticResource HexToBrush}}" />
                                            <!-- R row -->
                                            <Grid Margin="0,0,0,4">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="14" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="28" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="R" Foreground="#FFCC4444" FontSize="10" FontWeight="Bold"
                                                           VerticalAlignment="Center" />
                                                <Slider Grid.Column="1" Style="{StaticResource RgbSliderStyle}"
                                                        Value="{Binding FillR}" Margin="3,0" />
                                                <TextBlock Grid.Column="2" Text="{Binding FillR}" FontSize="10"
                                                           Foreground="{DynamicResource ForegroundBrush}"
                                                           VerticalAlignment="Center" HorizontalAlignment="Right" />
                                            </Grid>
                                            <!-- G row -->
                                            <Grid Margin="0,0,0,4">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="14" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="28" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="G" Foreground="#FF44CC44" FontSize="10" FontWeight="Bold"
                                                           VerticalAlignment="Center" />
                                                <Slider Grid.Column="1" Style="{StaticResource RgbSliderStyle}"
                                                        Value="{Binding FillG}" Margin="3,0" />
                                                <TextBlock Grid.Column="2" Text="{Binding FillG}" FontSize="10"
                                                           Foreground="{DynamicResource ForegroundBrush}"
                                                           VerticalAlignment="Center" HorizontalAlignment="Right" />
                                            </Grid>
                                            <!-- B row -->
                                            <Grid Margin="0,0,0,6">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="14" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="28" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="B" Foreground="#FF4488FF" FontSize="10" FontWeight="Bold"
                                                           VerticalAlignment="Center" />
                                                <Slider Grid.Column="1" Style="{StaticResource RgbSliderStyle}"
                                                        Value="{Binding FillB}" Margin="3,0" />
                                                <TextBlock Grid.Column="2" Text="{Binding FillB}" FontSize="10"
                                                           Foreground="{DynamicResource ForegroundBrush}"
                                                           VerticalAlignment="Center" HorizontalAlignment="Right" />
                                            </Grid>
                                            <!-- Hex entry -->
                                            <TextBox Text="{Binding FillColor, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{StaticResource PropTextBoxStyle}"
                                                     FontFamily="Consolas" />
                                            <!-- Save custom swatch -->
                                            <Button Margin="0,6,0,0"
                                                    Style="{StaticResource SaveSwatchButtonStyle}"
                                                    ToolTip="Save current color as a custom swatch&#x0a;Right-click any custom swatch to remove it"
                                                    Click="SaveFillSwatch_Click" />
                                        </StackPanel>
                                    </Border>
                                </Popup>

                                <!-- Close path (Polyline only) -->
                                <TextBlock Text="POLYLINE OPTIONS" Style="{StaticResource SectionLabelStyle}" />
                                <CheckBox IsChecked="{Binding IsClosedPath}"
                                          Foreground="{DynamicResource ForegroundBrush}"
                                          FontSize="11">
                                    <TextBlock Text="Close path (polygon)" FontSize="11" />
                                </CheckBox>

                                <!-- Divider -->
                                <Border Height="1"
                                        Background="{DynamicResource BorderBrush}"
                                        Margin="0,12,0,8" />

                                <!-- Element list header -->
                                <DockPanel Margin="0,0,0,4">
                                    <TextBlock Text="ELEMENTS" Style="{StaticResource SectionLabelStyle}"
                                               Margin="0" VerticalAlignment="Center" />
                                    <TextBlock x:Name="TbElementCount"
                                               HorizontalAlignment="Right"
                                               FontSize="10"
                                               Foreground="{DynamicResource IconForegroundBrush}"
                                               VerticalAlignment="Center" />
                                </DockPanel>

                                <!-- Element list -->
                                <ItemsControl x:Name="ElementList"
                                              ItemsSource="{Binding Elements}"
                                              MaxHeight="160">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Padding="4,3"
                                                    BorderBrush="{DynamicResource BorderBrush}"
                                                    BorderThickness="0,0,0,1">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>
                                                    <!-- Color chip -->
                                                    <Border Grid.Column="0"
                                                            Width="10" Height="10"
                                                            CornerRadius="2"
                                                            Margin="0,0,5,0"
                                                            VerticalAlignment="Center"
                                                            Background="{Binding StrokeColor, Converter={StaticResource HexToBrush}}" />
                                                    <!-- Type label -->
                                                    <TextBlock Grid.Column="1"
                                                               Text="{Binding Type}"
                                                               FontSize="10"
                                                               Foreground="{DynamicResource ForegroundBrush}"
                                                               VerticalAlignment="Center" />
                                                    <!-- Fill indicator -->
                                                    <materialDesign:PackIcon Grid.Column="2"
                                                                             Kind="FormatColorFill"
                                                                             Width="10" Height="10"
                                                                             VerticalAlignment="Center"
                                                                             Visibility="{Binding IsFilled, Converter={StaticResource BoolToVis}}"
                                                                             Foreground="{Binding FillColor, Converter={StaticResource HexToBrush}}" />
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                            </StackPanel>
                        </ScrollViewer>
                    </Border>
                </Grid>

                <!-- ── Footer ─────────────────────────────────────────────── -->
                <Border Grid.Row="3"
                        Background="{DynamicResource SecondaryBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,1,0,0"
                        CornerRadius="0,0,8,8"
                        Padding="12,7">
                    <DockPanel>
                        <!-- Cursor position -->
                        <TextBlock DockPanel.Dock="Left"
                                   Text="{Binding CursorPosition}"
                                   FontSize="10"
                                   FontFamily="Consolas"
                                   Foreground="{DynamicResource IconForegroundBrush}"
                                   VerticalAlignment="Center"
                                   MinWidth="120" />

                        <!-- Right-side actions -->
                        <StackPanel DockPanel.Dock="Right" Orientation="Horizontal"
                                    HorizontalAlignment="Right">
                            <Button Style="{StaticResource PulseActionButtonStyle}"
                                    Command="{Binding UndoCommand}"
                                    ToolTip="Undo last element (Ctrl+Z)"
                                    Margin="0,0,4,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Undo" Width="13" Height="13"
                                                             VerticalAlignment="Center" Margin="0,0,4,0" />
                                    <TextBlock Text="Undo" FontSize="11" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource PulseActionButtonStyle}"
                                    Command="{Binding RedoCommand}"
                                    ToolTip="Redo (Ctrl+Y)"
                                    Margin="0,0,4,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Redo" Width="13" Height="13"
                                                             VerticalAlignment="Center" Margin="0,0,4,0" />
                                    <TextBlock Text="Redo" FontSize="11" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource NegativeActionButtonStyle}"
                                    Command="{Binding DeleteSelectedCommand}"
                                    ToolTip="Delete selected element (Delete key)"
                                    Margin="0,0,4,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="DeleteForever" Width="13" Height="13"
                                                             VerticalAlignment="Center" Margin="0,0,4,0" />
                                    <TextBlock Text="Delete" FontSize="11" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource PulseActionButtonStyle}"
                                    Command="{Binding ClearCommand}"
                                    ToolTip="Clear all elements"
                                    Margin="0,0,16,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Delete" Width="13" Height="13"
                                                             VerticalAlignment="Center" Margin="0,0,4,0" />
                                    <TextBlock Text="Clear" FontSize="11" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                            <Button Style="{StaticResource PulseActionButtonStyle}"
                                    Command="{Binding CancelCommand}"
                                    Margin="0,0,8,0">
                                <TextBlock Text="Cancel" FontSize="11" />
                            </Button>
                            <Button Style="{StaticResource PulsePrimaryButtonStyle}"
                                    Command="{Binding SaveCommand}"
                                    ToolTip="Save this symbol to the library">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="ContentSave" Width="13" Height="13"
                                                             VerticalAlignment="Center" Margin="0,0,4,0" />
                                    <TextBlock Text="Save Symbol" FontSize="11" VerticalAlignment="Center" />
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </DockPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Window>
