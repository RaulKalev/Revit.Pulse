<UserControl
    x:Class="Pulse.UI.Controls.TopologyView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:converters="clr-namespace:Pulse.UI.Converters"
    mc:Ignorable="d">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Pulse;component/UI/Themes/DarkTheme.xaml" />
                <ResourceDictionary Source="pack://application:,,,/Pulse;component/UI/Themes/ElementStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>
            <BooleanToVisibilityConverter x:Key="BoolToVis"/>
            <converters:CountToVisibilityConverter x:Key="CountToVisibility"/>
        </ResourceDictionary>
    </UserControl.Resources>

    <Border Style="{DynamicResource CardBorderStyle}" Padding="0">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Title -->
            <Border Grid.Row="0" Padding="10,8"
                    BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                <TextBlock Text="System Topology"
                           FontSize="12" FontWeight="SemiBold"
                           Foreground="{DynamicResource ForegroundBrush}"/>
            </Border>

            <!-- Panel cards -->
            <ScrollViewer Grid.Row="1" Style="{StaticResource PulseScrollViewerStyle}">
                <ItemsControl ItemsSource="{Binding RootNodes}" Margin="6,6,6,0">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <!-- ╔══════════════╗ -->
                            <!-- ║  PANEL CARD  ║ -->
                            <!-- ╚══════════════╝ -->
                            <Border Margin="0,0,0,6"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1" CornerRadius="5"
                                    Background="{DynamicResource SecondaryBackgroundBrush}"
                                    Visibility="{Binding IsVisible, Converter={StaticResource BoolToVis}}">
                                <StackPanel>
                                    <!-- Panel header row -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="154"/>
                                            <ColumnDefinition Width="30"/>
                                        </Grid.ColumnDefinitions>
                                        <!-- Selection button (col 0) -->
                                        <Button Grid.Column="0"
                                                Command="{Binding SelectCommand}"
                                                Padding="10,8">
                                            <Button.Style>
                                                <Style TargetType="Button" BasedOn="{StaticResource PulseNodeButtonStyle}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                            <Setter Property="Background" Value="{DynamicResource SelectionHoverBrush}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                            <StackPanel Orientation="Horizontal">
                                                <materialDesign:PackIcon Kind="ServerNetwork" Width="14" Height="14"
                                                                         VerticalAlignment="Center" Margin="0,0,7,0"
                                                                         Foreground="{DynamicResource IconForegroundBrush}"/>
                                                <TextBlock Text="{Binding Label}" FontSize="12" FontWeight="SemiBold"
                                                           Foreground="{DynamicResource ForegroundBrush}"
                                                           VerticalAlignment="Center"/>
                                                <Border Style="{DynamicResource WarningBadgeStyle}"
                                                        Visibility="{Binding WarningCount, Converter={StaticResource CountToVisibility}}"
                                                        Margin="7,0,0,0">
                                                    <TextBlock Text="{Binding WarningCount}" FontSize="9"
                                                               FontWeight="Bold" Foreground="Black"/>
                                                </Border>
                                            </StackPanel>
                                        </Button>
                                        <!-- Config combobox (col 1) -->
                                        <ComboBox Grid.Column="1"
                                                  ItemsSource="{Binding AvailableConfigs}"
                                                  SelectedItem="{Binding AssignedConfig, Mode=TwoWay}"
                                                  Style="{StaticResource DarkComboBoxStyle}"
                                                  VerticalAlignment="Center" Margin="0,0,4,0"
                                                  Visibility="{Binding AvailableConfigs.Count,
                                                               Converter={StaticResource CountToVisibility}}"/>
                                        <!-- Expand/collapse chevron (col 2) -->
                                        <ToggleButton Grid.Column="2"
                                                      IsChecked="{Binding IsExpanded, Mode=TwoWay}"
                                                      OverridesDefaultStyle="True"
                                                      Cursor="Hand" Focusable="False"
                                                      Width="30" Background="Transparent"
                                                      BorderThickness="0">
                                            <ToggleButton.Template>
                                                <ControlTemplate TargetType="ToggleButton">
                                                    <Border Background="Transparent">
                                                        <Path x:Name="Chev" Data="M 0,0 L 4,4 L 8,0"
                                                              Stroke="{DynamicResource IconForegroundBrush}"
                                                              StrokeThickness="1.5" StrokeLineJoin="Round"
                                                              Width="8" Height="4"
                                                              HorizontalAlignment="Center"
                                                              VerticalAlignment="Center"
                                                              RenderTransformOrigin="0.5,0.5">
                                                            <Path.RenderTransform>
                                                                <RotateTransform x:Name="CR" Angle="0"/>
                                                            </Path.RenderTransform>
                                                        </Path>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsChecked" Value="False">
                                                            <Trigger.EnterActions>
                                                                <BeginStoryboard><Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetName="CR"
                                                                                     Storyboard.TargetProperty="Angle"
                                                                                     To="-90" Duration="0:0:0.12"/>
                                                                </Storyboard></BeginStoryboard>
                                                            </Trigger.EnterActions>
                                                            <Trigger.ExitActions>
                                                                <BeginStoryboard><Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetName="CR"
                                                                                     Storyboard.TargetProperty="Angle"
                                                                                     To="0" Duration="0:0:0.12"/>
                                                                </Storyboard></BeginStoryboard>
                                                            </Trigger.ExitActions>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </ToggleButton.Template>
                                        </ToggleButton>
                                    </Grid>

                                    <!-- Panel content (loops), shown when expanded -->
                                    <StackPanel Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVis}}">
                                        <Border Height="1" Background="{DynamicResource BorderBrush}"/>
                                        <ItemsControl ItemsSource="{Binding Children}" Margin="6,6,6,6">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <!-- ╔═════════════╗ -->
                                                    <!-- ║  LOOP CARD  ║ -->
                                                    <!-- ╚═════════════╝ -->
                                                    <Border Margin="0,0,0,4"
                                                            BorderBrush="{DynamicResource BorderBrush}"
                                                            BorderThickness="1" CornerRadius="4"
                                                            Background="{DynamicResource PrimaryBackgroundBrush}"
                                                            Visibility="{Binding IsVisible, Converter={StaticResource BoolToVis}}">
                                                        <StackPanel>
                                                            <!-- Loop header row -->
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>  <!-- wire combobox -->
                                                                    <ColumnDefinition Width="141"/>   <!-- module combobox -->
                                                                    <ColumnDefinition Width="28"/>    <!-- expand toggle -->
                                                                </Grid.ColumnDefinitions>
                                                                <Button Grid.Column="0"
                                                                        Command="{Binding SelectCommand}"
                                                                        Padding="8,6">
                                                                    <Button.Style>
                                                                        <Style TargetType="Button" BasedOn="{StaticResource PulseNodeButtonStyle}">
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                                                    <Setter Property="Background" Value="{DynamicResource SelectionHoverBrush}"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </Button.Style>
                                                                    <StackPanel Orientation="Horizontal">
                                                                        <materialDesign:PackIcon Kind="VectorPolyline" Width="13" Height="13"
                                                                                                 VerticalAlignment="Center" Margin="0,0,6,0"
                                                                                                 Foreground="{DynamicResource IconForegroundBrush}"/>
                                                                        <TextBlock Text="{Binding Label}" FontSize="11"
                                                                                   Foreground="{DynamicResource ForegroundBrush}"
                                                                                   VerticalAlignment="Center"/>
                                                                        <TextBlock Text="{Binding SubInfo}" FontSize="10"
                                                                                   Foreground="{DynamicResource IconForegroundBrush}"
                                                                                   VerticalAlignment="Center" Margin="5,0,0,0" Opacity="0.7"/>
                                                                        <Border Style="{DynamicResource WarningBadgeStyle}"
                                                                                Visibility="{Binding WarningCount, Converter={StaticResource CountToVisibility}}"
                                                                                Margin="6,0,0,0">
                                                                            <TextBlock Text="{Binding WarningCount}" FontSize="9"
                                                                                       FontWeight="Bold" Foreground="Black"/>
                                                                        </Border>
                                                                    </StackPanel>
                                                                </Button>
                                                                <!-- Wire type combobox (col 1) -->
                                                                <ComboBox Grid.Column="1"
                                                                          ItemsSource="{Binding AvailableWires}"
                                                                          SelectedItem="{Binding AssignedWire, Mode=TwoWay}"
                                                                          Style="{StaticResource DarkComboBoxStyle}"
                                                                          VerticalAlignment="Center"
                                                                          MinWidth="110"
                                                                          Margin="0,0,4,0"
                                                                          Visibility="{Binding AvailableWires.Count,
                                                                                       Converter={StaticResource CountToVisibility}}"/>
                                                                <!-- Loop module config combobox (col 2) -->
                                                                <ComboBox Grid.Column="2"
                                                                          ItemsSource="{Binding AvailableConfigs}"
                                                                          SelectedItem="{Binding AssignedConfig, Mode=TwoWay}"
                                                                          Style="{StaticResource DarkComboBoxStyle}"
                                                                          VerticalAlignment="Center" Margin="0,0,4,0"
                                                                          Visibility="{Binding AvailableConfigs.Count,
                                                                                       Converter={StaticResource CountToVisibility}}"/>
                                                                <ToggleButton Grid.Column="3"
                                                                              IsChecked="{Binding IsExpanded, Mode=TwoWay}"
                                                                              OverridesDefaultStyle="True"
                                                                              Cursor="Hand" Focusable="False"
                                                                              Width="28" Background="Transparent"
                                                                              BorderThickness="0">
                                                                    <ToggleButton.Template>
                                                                        <ControlTemplate TargetType="ToggleButton">
                                                                            <Border Background="Transparent">
                                                                                <Path x:Name="Chev2" Data="M 0,0 L 4,4 L 8,0"
                                                                                      Stroke="{DynamicResource IconForegroundBrush}"
                                                                                      StrokeThickness="1.5" StrokeLineJoin="Round"
                                                                                      Width="8" Height="4"
                                                                                      HorizontalAlignment="Center"
                                                                                      VerticalAlignment="Center"
                                                                                      RenderTransformOrigin="0.5,0.5">
                                                                                    <Path.RenderTransform>
                                                                                        <RotateTransform x:Name="CR2" Angle="0"/>
                                                                                    </Path.RenderTransform>
                                                                                </Path>
                                                                            </Border>
                                                                            <ControlTemplate.Triggers>
                                                                                <Trigger Property="IsChecked" Value="False">
                                                                                    <Trigger.EnterActions>
                                                                                        <BeginStoryboard><Storyboard>
                                                                                            <DoubleAnimation Storyboard.TargetName="CR2"
                                                                                                             Storyboard.TargetProperty="Angle"
                                                                                                             To="-90" Duration="0:0:0.12"/>
                                                                                        </Storyboard></BeginStoryboard>
                                                                                    </Trigger.EnterActions>
                                                                                    <Trigger.ExitActions>
                                                                                        <BeginStoryboard><Storyboard>
                                                                                            <DoubleAnimation Storyboard.TargetName="CR2"
                                                                                                             Storyboard.TargetProperty="Angle"
                                                                                                             To="0" Duration="0:0:0.12"/>
                                                                                        </Storyboard></BeginStoryboard>
                                                                                    </Trigger.ExitActions>
                                                                                </Trigger>
                                                                            </ControlTemplate.Triggers>
                                                                        </ControlTemplate>
                                                                    </ToggleButton.Template>
                                                                </ToggleButton>
                                                            </Grid>

                                                            <!-- Loop content (devices), shown when expanded -->
                                                            <StackPanel Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVis}}">
                                                                <Border Height="1" Background="{DynamicResource BorderBrush}"/>
                                                                <ItemsControl ItemsSource="{Binding Children}" Margin="0,2,0,2">
                                                                    <ItemsControl.ItemTemplate>
                                                                        <DataTemplate>
                                                                            <!-- Device row -->
                                                                            <StackPanel Visibility="{Binding IsVisible, Converter={StaticResource BoolToVis}}">
                                                                                <!-- Main row: select button + "+" toggle -->
                                                                                <Grid>
                                                                                    <Grid.ColumnDefinitions>
                                                                                        <ColumnDefinition Width="*"/>
                                                                                        <ColumnDefinition Width="Auto"/>
                                                                                    </Grid.ColumnDefinitions>
                                                                                    <Button Grid.Column="0"
                                                                                            Command="{Binding SelectCommand}"
                                                                                            Padding="20,5,8,5">
                                                                                        <Button.Style>
                                                                                            <Style TargetType="Button" BasedOn="{StaticResource PulseNodeButtonStyle}">
                                                                                                <Style.Triggers>
                                                                                                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                                                                        <Setter Property="Background" Value="{DynamicResource SelectionHoverBrush}"/>
                                                                                                    </DataTrigger>
                                                                                                </Style.Triggers>
                                                                                            </Style>
                                                                                        </Button.Style>
                                                                                        <StackPanel Orientation="Horizontal">
                                                                                            <materialDesign:PackIcon Kind="AccessPoint"
                                                                                                                     Width="12" Height="12"
                                                                                                                     VerticalAlignment="Center" Margin="0,0,6,0"
                                                                                                                     Foreground="{DynamicResource IconForegroundBrush}"/>
                                                                                            <TextBlock Text="{Binding Label}" FontSize="11"
                                                                                                       Foreground="{DynamicResource ForegroundBrush}"
                                                                                                       VerticalAlignment="Center"/>
                                                                                            <Border Style="{DynamicResource WarningBadgeStyle}"
                                                                                                    Visibility="{Binding WarningCount, Converter={StaticResource CountToVisibility}}"
                                                                                                    Margin="6,0,0,0">
                                                                                                <TextBlock Text="{Binding WarningCount}" FontSize="9"
                                                                                                           FontWeight="Bold" Foreground="Black"/>
                                                                                            </Border>
                                                                                        </StackPanel>
                                                                                    </Button>
                                                                                    <!-- "+" toggle button — only shown when unassigned devices exist -->
                                                                                    <Button Grid.Column="1"
                                                                                            Command="{Binding ToggleAddSlotCommand}"
                                                                                            Visibility="{Binding AvailableUnassigned.Count, Converter={StaticResource CountToVisibility}}"
                                                                                            ToolTip="Assign an unassigned device beneath this device"
                                                                                            Padding="4,4,4,4"
                                                                                            MinWidth="24">
                                                                                        <Button.Style>
                                                                                            <Style TargetType="Button" BasedOn="{StaticResource PulseNodeButtonStyle}">
                                                                                                <Style.Triggers>
                                                                                                    <DataTrigger Binding="{Binding IsAddSlotOpen}" Value="True">
                                                                                                        <Setter Property="Background" Value="{DynamicResource SelectionHoverBrush}"/>
                                                                                                    </DataTrigger>
                                                                                                </Style.Triggers>
                                                                                            </Style>
                                                                                        </Button.Style>
                                                                                        <materialDesign:PackIcon Kind="Plus" Width="10" Height="10"
                                                                                                                 Foreground="{DynamicResource IconForegroundBrush}"/>
                                                                                    </Button>
                                                                                </Grid>
                                                                                <!-- Add-slot row: combobox to pick an unassigned device -->
                                                                                <Border Visibility="{Binding IsAddSlotOpen, Converter={StaticResource BoolToVis}}"
                                                                                        Margin="28,0,4,4" Padding="4,3"
                                                                                        BorderBrush="{DynamicResource BorderBrush}"
                                                                                        BorderThickness="1" CornerRadius="3">
                                                                                    <Grid>
                                                                                        <Grid.ColumnDefinitions>
                                                                                            <ColumnDefinition Width="Auto"/>
                                                                                            <ColumnDefinition Width="*"/>
                                                                                        </Grid.ColumnDefinitions>
                                                                                        <TextBlock Grid.Column="0"
                                                                                                   Text="Assign → "
                                                                                                   FontSize="10"
                                                                                                   Foreground="{DynamicResource IconForegroundBrush}"
                                                                                                   VerticalAlignment="Center"/>
                                                                                        <ComboBox Grid.Column="1"
                                                                                                  ItemsSource="{Binding AvailableUnassigned}"
                                                                                                  SelectedItem="{Binding SelectedUnassigned, Mode=TwoWay}"
                                                                                                  Style="{StaticResource DarkComboBoxStyle}"
                                                                                                  VerticalAlignment="Center"/>
                                                                                    </Grid>
                                                                                </Border>
                                                                            </StackPanel>
                                                                        </DataTemplate>
                                                                    </ItemsControl.ItemTemplate>
                                                                </ItemsControl>
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- Empty state -->
            <StackPanel Grid.Row="1"
                        HorizontalAlignment="Center" VerticalAlignment="Center"
                        Visibility="{Binding RootNodes.Count, Converter={StaticResource CountToVisibility}, ConverterParameter=Invert}">
                <materialDesign:PackIcon Kind="DatabaseOff" Width="40" Height="40"
                                         HorizontalAlignment="Center"
                                         Foreground="{DynamicResource IconForegroundBrush}" Opacity="0.4"/>
                <TextBlock Text="No data loaded" FontSize="12"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource IconForegroundBrush}" Opacity="0.6" Margin="0,8,0,0"/>
                <TextBlock Text="Press Refresh to collect system data" FontSize="10"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource IconForegroundBrush}" Opacity="0.4" Margin="0,2,0,0"/>
            </StackPanel>
        </Grid>
    </Border>
</UserControl>

