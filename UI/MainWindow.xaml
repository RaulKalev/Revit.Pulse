<Window
    x:Class="Pulse.UI.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:ui="clr-namespace:Pulse.UI"
    xmlns:controls="clr-namespace:Pulse.UI.Controls"
    xmlns:converters="clr-namespace:Pulse.UI.Converters"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="Pulse"
    Width="1200"
    Height="650"
    MinWidth="920"
    MinHeight="500"
    AllowsTransparency="True"
    Background="Transparent"
    WindowStyle="None"
    MouseMove="Window_MouseMove"
    MouseUp="Window_MouseUp"
    mc:Ignorable="d">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <!-- Default dark theme brushes (overridden at runtime by theme switch) -->
                <ResourceDictionary>
                    <SolidColorBrush x:Key="PrimaryBackgroundBrush" Color="#FF1F1F1F" />
                    <SolidColorBrush x:Key="SecondaryBackgroundBrush" Color="#FF292929" />
                    <SolidColorBrush x:Key="BorderBrush" Color="#FF444444" />
                    <SolidColorBrush x:Key="ForegroundBrush" Color="#EEEEEE" />
                </ResourceDictionary>
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.Dark.xaml" />
                <ResourceDictionary Source="pack://application:,,,/Pulse;component/UI/Themes/ElementStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
            <converters:CountToVisibilityConverter x:Key="CountToVisibility"/>
            <converters:NullToVisibilityConverter x:Key="NullToVisibility"/>
            <converters:SeverityToBrushConverter x:Key="SeverityToBrush"/>
            <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        </ResourceDictionary>
    </Window.Resources>

    <Grid Background="Transparent" ClipToBounds="True">
        <!-- Outer Border with Opacity and Blur (same as original ProSchedules) -->
        <Border
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="2"
            ClipToBounds="True"
            CornerRadius="10"
            Opacity="0.7"
            SnapsToDevicePixels="True">
            <Border.Effect>
                <BlurEffect KernelType="Gaussian" Radius="2" />
            </Border.Effect>
        </Border>

        <!-- Content Container -->
        <Border
            Margin="2"
            Background="{DynamicResource PrimaryBackgroundBrush}"
            CornerRadius="10">
            <Grid x:Name="MainContentGrid">
                <Grid.RowDefinitions>
                    <RowDefinition Height="30" />  <!-- Title bar -->
                    <RowDefinition Height="Auto" /> <!-- Toolbar / Filter bar -->
                    <RowDefinition Height="*" />    <!-- Main content area -->
                    <RowDefinition Height="24" />   <!-- Status strip -->
                </Grid.RowDefinitions>

                <!-- Row 0: Title Bar -->
                <ui:TitleBar Grid.Row="0" Foreground="{DynamicResource IconBrush}" />

                <!-- Row 1: Toolbar -->
                <Border Grid.Row="1"
                        Background="{DynamicResource SecondaryBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,0,0,1"
                        Padding="8,4">
                    <DockPanel>
                        <!-- Module name -->
                        <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center">
                            <materialDesign:PackIcon Kind="Fire" Width="18" Height="18"
                                                     Foreground="#FFDC6B6B" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <TextBlock Text="{Binding ActiveModuleName}"
                                       FontSize="13" FontWeight="SemiBold"
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- Right-side toolbar buttons -->
                        <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" HorizontalAlignment="Right">
                            <!-- Warnings-only toggle -->
                            <ToggleButton Style="{StaticResource PulseToggleButtonStyle}"
                                          IsChecked="{Binding ShowWarningsOnly}"
                                          ToolTip="Show only items with warnings"
                                          Margin="0,0,4,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="AlertOutline" Width="14" Height="14" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                    <TextBlock Text="Warnings" FontSize="11" VerticalAlignment="Center"/>
                                </StackPanel>
                            </ToggleButton>

                            <!-- Device Configurator -->
                            <Button Style="{StaticResource PulseActionButtonStyle}"
                                    Command="{Binding OpenDeviceConfiguratorCommand}"
                                    ToolTip="Configure control panels and loop modules"
                                    Margin="0,0,4,0">
                                <materialDesign:PackIcon Kind="Wrench" Width="14" Height="14" VerticalAlignment="Center"/>
                            </Button>

                            <!-- Symbol Mapping -->
                            <Button Style="{StaticResource PulseActionButtonStyle}"
                                    Command="{Binding OpenSymbolMappingCommand}"
                                    ToolTip="Map symbols to loop elements"
                                    Margin="0,0,4,0">
                                <materialDesign:PackIcon Kind="ShapePlus" Width="14" Height="14" VerticalAlignment="Center"/>
                            </Button>

                            <!-- Settings -->
                            <Button Style="{StaticResource PulseActionButtonStyle}"
                                    Command="{Binding OpenSettingsCommand}"
                                    ToolTip="Configure parameter mappings"
                                    Margin="0,0,4,0">
                                <materialDesign:PackIcon Kind="Cog" Width="14" Height="14" VerticalAlignment="Center"/>
                            </Button>

                            <Button Style="{StaticResource PulseActionButtonStyle}"
                                    Command="{Binding ResetOverridesCommand}"
                                    ToolTip="Reset temporary graphic overrides in Revit"
                                    Margin="0,0,4,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Refresh" Width="14" Height="14" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                    <TextBlock Text="Reset" FontSize="11" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>

                            <!-- Refresh button -->
                            <Button Style="{StaticResource PulsePrimaryButtonStyle}"
                                    Command="{Binding RefreshCommand}"
                                    ToolTip="Refresh data from Revit">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="DatabaseRefresh" Width="14" Height="14" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                    <TextBlock Text="Refresh" FontSize="11" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </DockPanel>
                </Border>

                <!-- Row 2: Main Content (Topology + Inspector | Diagram) -->
                <Grid Grid.Row="2" ClipToBounds="True">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" MinWidth="551" />   <!-- Left block: Topology + Inspector (min: inspector 300 + splitter 1 + topology 250) -->
                        <ColumnDefinition Width="1" />                   <!-- Splitter -->
                        <ColumnDefinition Width="300" MinWidth="46" />  <!-- Diagram (MinWidth managed in code-behind: 46 collapsed / 210 expanded) -->
                    </Grid.ColumnDefinitions>

                    <!-- Left block: Topology + Inspector side by side -->
                    <Grid Grid.Column="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" MinWidth="250" />    <!-- Topology -->
                            <ColumnDefinition Width="1" />                    <!-- Splitter -->
                            <ColumnDefinition Width="300" MinWidth="300" MaxWidth="300" />  <!-- Inspector -->
                        </Grid.ColumnDefinitions>

                        <controls:TopologyView Grid.Column="0" DataContext="{Binding Topology}" Margin="4"/>

                        <GridSplitter Grid.Column="1"
                                      Width="1"
                                      HorizontalAlignment="Stretch"
                                      Background="{DynamicResource BorderBrush}"
                                      Cursor="SizeWE"/>

                        <controls:InspectorPanel Grid.Column="2" DataContext="{Binding Inspector}" Margin="4"/>
                    </Grid>

                    <!-- GridSplitter (Left block | Diagram) -->
                    <GridSplitter Grid.Column="1"
                                  Width="1"
                                  HorizontalAlignment="Stretch"
                                  VerticalAlignment="Stretch"
                                  ResizeDirection="Columns"
                                  Background="{DynamicResource BorderBrush}"
                                  Cursor="SizeWE"/>

                    <!-- Diagram Panel -->
                    <controls:DiagramPanel x:Name="TheDiagramPanel" Grid.Column="2" DataContext="{Binding Diagram}" Margin="4,0,0,0"/>
                </Grid>

                <!-- Row 3: Status Strip -->
                <controls:StatusStrip Grid.Row="3" DataContext="{Binding}"/>

                <!-- Loading overlay -->
                <Border Grid.Row="0" Grid.RowSpan="4"
                        Background="#80000000"
                        Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}"
                        CornerRadius="10"
                        IsHitTestVisible="True">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <ProgressBar IsIndeterminate="True" Width="200" Height="4" Margin="0,0,0,8"/>
                        <TextBlock Text="Collecting data..." Foreground="White" FontSize="12" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- Resize grips (same pattern as original ProSchedules) -->
        <Border x:Name="ResizeLeft" Width="5" HorizontalAlignment="Left" Background="Transparent" Cursor="SizeWE"
                MouseDown="ResizeLeft_MouseDown"/>
        <Border x:Name="ResizeRight" Width="5" HorizontalAlignment="Right" Background="Transparent" Cursor="SizeWE"
                MouseDown="ResizeRight_MouseDown"/>
        <Border x:Name="ResizeBottom" Height="5" VerticalAlignment="Bottom" Background="Transparent" Cursor="SizeNS"
                MouseDown="ResizeBottom_MouseDown"/>
        <Border x:Name="ResizeBottomLeft" Width="10" Height="10" HorizontalAlignment="Left" VerticalAlignment="Bottom"
                Background="Transparent" Cursor="SizeNESW" MouseDown="ResizeBottomLeft_MouseDown"/>
        <Border x:Name="ResizeBottomRight" Width="10" Height="10" HorizontalAlignment="Right" VerticalAlignment="Bottom"
                Background="Transparent" Cursor="SizeNWSE" MouseDown="ResizeBottomRight_MouseDown"/>
    </Grid>
</Window>
